<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shared Mini Browser</title>
<style>
body { font-family: sans-serif; margin: 10px; }
input { width: 50%; padding: 5px; margin-top: 5px; }
button { padding: 5px 10px; margin-left: 5px; margin-top: 5px; }
iframe { width: 100%; height: 500px; margin-top: 10px; border: 1px solid #ccc; }
#status { margin-top: 5px; color: #555; }
#preload { margin-top: 10px; }
#preload button { margin-right: 5px; margin-top: 5px; }
</style>
</head>
<body>

<h2>Shared Mini Browser</h2>

<div id="preload">
  <strong>Preloaded Sites:</strong>
  <button data-url="https://discord-activity.pages.dev">Activity Home</button>
  <button data-url="https://discord-activity.pages.dev/emulatorjs/index.html">EmulatorJS</button>
  <button data-url="https://discord-activity.pages.dev/game1.html">Game 1</button>
  <button data-url="https://discord-activity.pages.dev/game2.html">Game 2</button>
</div>

<div id="custom">
  <input id="url" placeholder="Enter a custom URL (must allow iframe)" />
  <button id="go">Go</button>
</div>

<iframe id="frame"></iframe>
<div id="status">All users in VC will see the same page.</div>

<script>
const frame = document.getElementById('frame');
const status = document.getElementById('status');
const urlInput = document.getElementById('url');
const goButton = document.getElementById('go');
const preloadButtons = document.querySelectorAll('#preload button');

// List of safe iframe sites (add your hosted URLs here)
const safeSites = [
  'https://discord-activity.pages.dev',
  'https://discord-activity.pages.dev/emulatorjs/',
  'https://discord-activity.pages.dev/game1.html',
  'https://discord-activity.pages.dev/game2.html'
];

// SSE connection to sync URLs
const evtSource = new EventSource('https://shared-browse.contactlandinreese.workers.dev/events');
evtSource.onmessage = e => {
  if (e.data === 'ping') return;
  loadURL(e.data, false); // false = do not resend to server
};

// Preloaded buttons
preloadButtons.forEach(btn => {
  btn.onclick = () => {
    const url = btn.getAttribute('data-url');
    loadURL(url, true); // broadcast to all
  };
});

// Custom URL input
goButton.onclick = () => {
  const url = urlInput.value.trim();
  if (!url) return;
  loadURL(url, true);
};

// Load URL in iframe if safe
function loadURL(url, sendToServer) {
  if (!url.startsWith('http')) url = 'https://' + url;

  const isSafe = safeSites.some(s => url.startsWith(s));

  if (isSafe) {
    frame.src = url;
    status.textContent = `Loaded in iframe: ${url}`;
  } else {
    frame.src = '';
    status.textContent = `Cannot load in iframe: ${url} (must allow iframe)`;
  }

  // Broadcast URL to all other clients
  if (sendToServer) {
    fetch('https://shared-browse.contactlandinreese.workers.dev/set', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
  }
}
</script>

</body>
</html>
